#!/usr/bin/env groovy

def label = "k8sagent-shipping-deploy"
def home = "/home/jenkins"
def workspace = "${home}/workspace/shipping-deploy"
def workdir = "${workspace}/shipping-deploy/"

podTemplate(label: label,
  containers: [
    containerTemplate(name: 'kubectl', image: 'cloudarchitecturedemo/agent:0.1', ttyEnabled: true, command: 'cat'),
  ],
) {
node(label) {
  stage('Shipping product deploy job') {
    //withCredentials([usernamePassword(credentialsId: 'github-user-token', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
    container('kubectl') {
      sh '''
        echo "This is the shipping deploy pipeline."

        ## Prepare environment
        git clone https://github.com/cloud-architecture-demo/sock-shop-configuration.git -b gke-jcasc-demo

        ## Deploy shipping app to kubernetes
        kubectl -n sock-shop apply -f ./jenkins-seed-jobs/socks-shop/shipping/deploy/kubernetes
      '''
      }
      //}
    }
  }
}